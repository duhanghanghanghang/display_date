# 清理旧数据说明

## 背景
已将认证方式从 JWT Token 改为直接使用 OpenID，需要清理小程序中的旧数据。

## 清理步骤

### 方式1：在小程序开发者工具中清理

1. 打开微信开发者工具
2. 打开"调试器" - "Storage" - "Storage"
3. 找到并删除以下缓存项：
   - `token`（旧的 JWT token，已不再使用）
4. **保留**以下缓存项：
   - `openid`（新的认证方式）
   - `reminderSettings`（提醒设置）
   - 其他业务数据

### 方式2：在小程序代码中添加清理逻辑

在 `app.js` 的 `onLaunch` 方法开始处添加：

```javascript
async onLaunch() {
  // 清理旧的 token（已不再使用）
  wx.removeStorageSync('token')
  
  // ... 其他代码
}
```

### 方式3：真机调试时清理

1. 在真机上删除小程序
2. 重新打开小程序（会自动重新登录获取 openid）

## 新的认证流程

1. **登录**：调用 `POST /login` 接口，使用微信 code 换取 openid
2. **认证**：所有请求在 header 中携带 `X-OpenId: <openid>`
3. **本地缓存**：只需缓存 openid，不再需要 token

## 验证是否修复成功

修改后，在真机调试时：

1. 删除小程序重新打开
2. 查看控制台是否有 "登录成功，openid: xxx" 的日志
3. 进入首页，查看是否能正常加载数据
4. 如果能正常显示数据，说明修复成功

## 常见问题

### Q: 还是提示 "Missing openid in header"
A: 检查以下几点：
- 小程序是否成功登录（查看控制台日志）
- request.js 是否已更新为使用 `X-OpenId` header
- app.js 是否已更新 ensureOpenId 方法
- 清除旧的 token 缓存

### Q: 提示 "登录失败"
A: 检查：
- 后端服务是否正常运行（访问 http://your-api/docs）
- 网络请求地址是否正确（utils/config.js 中的 BASE_URL）
- 微信开发者工具中是否勾选了"不校验合法域名"

### Q: 开发环境可以，真机不行
A: 需要：
- 在小程序管理后台配置服务器域名（request 合法域名）
- 确保后端服务使用 HTTPS（生产环境必须）
- 或者在真机上开启调试模式（开发阶段）

